stages:
  - build
  - test
  - deploy
  - cleanup

variables:
  IMAGE: "prozorro/catalog/develop:$CI_COMMIT_SHORT_SHA"
  IMAGE_TEST: "prozorro/catalog/develop:$CI_COMMIT_SHORT_SHA-test"
  IMAGE_FULL_NAME: "docker-registry.prozorro.gov.ua/cdb/prozorro-catalog"
  IMAGE_TAG: "latest"
  HELM: "helm3"


build_images:
  stage: build
  script:
    - make docker-build
  except:
    - schedules
  tags:
    - shell


test-integration:
  stage: test
  tags:
    - kube-dev
  image: $IMAGE_TEST
  services:
    - bitnami/mongodb:latest
  variables:
    MONGODB_URI: mongodb://root:example@mongo:27017/?replicaSet=rs0
    MONGODB_ROOT_PASSWORD: example
    MONGODB_REPLICA_SET_MODE: primary
    MONGODB_REPLICA_SET_NAME: rs0
    MONGODB_REPLICA_SET_KEY: replicaSetKey
  script:
    - pytest --cov=catalog --cov-report xml tests/integration/
  artifacts:
    paths:
      - coverage.xml


review:
  stage: deploy
  tags:
    - shell
  environment:
    name: review/${CI_COMMIT_REF_SLUG}
    action: start
    url: http://api.${CI_COMMIT_REF_SLUG}.${K8S_DOMAIN}/api/ping
    on_stop: stop_review
    auto_stop_in: 1 month
  variables:
    TAG: $CI_COMMIT_REF_SLUG
  script:
    - make dev-update
  when: manual
  only:
    - master


stop_review:
  stage: deploy
  script:
    - make dev-auth-secret-delete
  environment:
    name: review/${CI_COMMIT_REF_SLUG}
    action: stop
  tags:
    - shell
  when: manual
  only:
    - master


clenup-images:
  stage: cleanup
  tags:
    - shell
  script:
    - docker rmi -f $IMAGE || true
    - docker rmi -f $IMAGE_TEST || true
  when: always
